<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Chrome Test - ApexShare Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { border-color: green; background: #f0f8f0; }
        .error { border-color: red; background: #f8f0f0; }
        .info { border-color: blue; background: #f0f0f8; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .results { font-family: monospace; background: #f0f0f0; padding: 10px; margin: 10px 0; }
        .log { margin: 5px 0; padding: 5px; background: #fafafa; border-left: 3px solid #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Manual Chrome Testing - ApexShare Upload Debug</h1>

        <div class="test-section info">
            <h3>Browser Information</h3>
            <div id="browser-info"></div>
        </div>

        <div class="test-section">
            <h3>Test 1: Session Creation</h3>
            <button onclick="testSessionCreation()">Test Session Creation</button>
            <div id="session-results" class="results"></div>
        </div>

        <div class="test-section">
            <h3>Test 2: Upload URL with Valid Session ID</h3>
            <button onclick="testValidUploadUrl()">Test Valid Upload URL</button>
            <div id="valid-upload-results" class="results"></div>
        </div>

        <div class="test-section">
            <h3>Test 3: Upload URL with UNDEFINED Session ID (The Problem)</h3>
            <button onclick="testUndefinedUploadUrl()">Test Undefined Session ID</button>
            <div id="undefined-upload-results" class="results"></div>
        </div>

        <div class="test-section">
            <h3>Test 4: Visit Actual Debug Page</h3>
            <button onclick="visitDebugPage()">Open Debug Page</button>
            <div id="debug-page-results" class="results"></div>
        </div>

        <div class="test-section">
            <h3>Console Logs</h3>
            <div id="console-logs"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://l0hx9zgow8.execute-api.eu-west-1.amazonaws.com/v1';
        let testSessionId = null;
        let logs = [];

        // Initialize browser info
        document.addEventListener('DOMContentLoaded', function() {
            const browserInfo = document.getElementById('browser-info');
            const isChrome = navigator.userAgent.includes('Chrome') && !navigator.userAgent.includes('Electron');
            browserInfo.innerHTML = `
                <div class="log">User Agent: ${navigator.userAgent}</div>
                <div class="log">Is Chrome (not Electron): ${isChrome ? '‚úÖ YES' : '‚ùå NO'}</div>
                <div class="log">Timestamp: ${new Date().toISOString()}</div>
            `;
        });

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push(logEntry);

            const consoleLogsDiv = document.getElementById('console-logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.textContent = logEntry;
            consoleLogsDiv.appendChild(logDiv);

            console.log(message);
        }

        async function testSessionCreation() {
            const resultsDiv = document.getElementById('session-results');
            resultsDiv.innerHTML = 'Testing session creation...';

            try {
                const response = await fetch(`${API_BASE_URL}/sessions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Public-Access': 'true',
                        'Origin': 'https://apexshare.be'
                    },
                    body: JSON.stringify({
                        studentName: 'Manual Chrome Test',
                        studentEmail: 'chrome.test@example.com',
                        sessionDate: '2025-01-22',
                        notes: 'Manual Chrome browser testing'
                    })
                });

                const data = await response.json();
                testSessionId = data.data?.id;

                if (response.status === 201 && testSessionId) {
                    resultsDiv.innerHTML = `
                        <div class="success">‚úÖ Session creation SUCCESS</div>
                        <div>Status: ${response.status}</div>
                        <div>Session ID: ${testSessionId}</div>
                        <div>Response: ${JSON.stringify(data, null, 2)}</div>
                    `;
                    log('Session creation successful', 'success');
                } else {
                    throw new Error(`Unexpected response: ${response.status}`);
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">‚ùå Session creation FAILED</div>
                    <div>Error: ${error.message}</div>
                `;
                log(`Session creation failed: ${error.message}`, 'error');
            }
        }

        async function testValidUploadUrl() {
            const resultsDiv = document.getElementById('valid-upload-results');

            if (!testSessionId) {
                resultsDiv.innerHTML = '<div class="error">‚ùå Please run Session Creation test first</div>';
                return;
            }

            resultsDiv.innerHTML = 'Testing upload URL with valid session ID...';

            try {
                const response = await fetch(`${API_BASE_URL}/sessions/${testSessionId}/upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Public-Access': 'true',
                        'Origin': 'https://apexshare.be',
                        'X-Debug-Student-Email': 'chrome.test@example.com',
                        'X-Debug-Student-Name': 'Manual Chrome Test',
                        'X-Debug-Notes': 'Manual Chrome browser testing'
                    },
                    body: JSON.stringify({
                        fileName: 'chrome-test.mp4',
                        fileSize: 1048576,
                        contentType: 'video/mp4'
                    })
                });

                const data = await response.json();

                if (response.status === 200 && data.data?.uploadUrl) {
                    resultsDiv.innerHTML = `
                        <div class="success">‚úÖ Valid session upload URL SUCCESS</div>
                        <div>Status: ${response.status}</div>
                        <div>Upload URL: ${data.data.uploadUrl}</div>
                        <div>Response: ${JSON.stringify(data, null, 2)}</div>
                    `;
                    log('Valid session upload URL successful', 'success');
                } else {
                    throw new Error(`Unexpected response: ${response.status}`);
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">‚ùå Valid session upload URL FAILED</div>
                    <div>Error: ${error.message}</div>
                `;
                log(`Valid session upload URL failed: ${error.message}`, 'error');
            }
        }

        async function testUndefinedUploadUrl() {
            const resultsDiv = document.getElementById('undefined-upload-results');
            resultsDiv.innerHTML = 'Testing upload URL with UNDEFINED session ID...';

            try {
                const response = await fetch(`${API_BASE_URL}/sessions/undefined/upload`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Public-Access': 'true',
                        'Origin': 'https://apexshare.be'
                    },
                    body: JSON.stringify({
                        fileName: 'undefined-test.mp4',
                        fileSize: 1048576,
                        contentType: 'video/mp4'
                    })
                });

                const data = await response.json();

                // This SHOULD fail, but if it succeeds, that's the bug!
                if (response.status === 200) {
                    resultsDiv.innerHTML = `
                        <div class="error">‚ùå PROBLEM FOUND: API accepts 'undefined' as session ID!</div>
                        <div>Status: ${response.status} (should be 400 or 404)</div>
                        <div>Upload URL: ${data.data?.uploadUrl}</div>
                        <div>This is the source of the bug - undefined session IDs should be rejected</div>
                        <div>Response: ${JSON.stringify(data, null, 2)}</div>
                    `;
                    log('BUG CONFIRMED: API accepts undefined session ID', 'error');
                } else {
                    resultsDiv.innerHTML = `
                        <div class="success">‚úÖ Good: API properly rejects undefined session ID</div>
                        <div>Status: ${response.status}</div>
                        <div>Response: ${JSON.stringify(data, null, 2)}</div>
                    `;
                    log('API properly rejects undefined session ID', 'success');
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="success">‚úÖ Good: Request failed as expected</div>
                    <div>Error: ${error.message}</div>
                    <div>This means the API is properly rejecting invalid session IDs</div>
                `;
                log(`Undefined session ID properly rejected: ${error.message}`, 'success');
            }
        }

        function visitDebugPage() {
            const resultsDiv = document.getElementById('debug-page-results');
            resultsDiv.innerHTML = 'Opening debug page in new tab...';

            window.open('https://apexshare.be/upload-debug', '_blank');

            resultsDiv.innerHTML = `
                <div class="info">üìÑ Debug page opened in new tab</div>
                <div>Check the new tab for the actual debug page behavior</div>
                <div>Look for any console errors or network issues</div>
            `;

            log('Debug page opened in new tab', 'info');
        }

        // Capture any console errors
        window.addEventListener('error', function(e) {
            log(`JavaScript Error: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
        });

        // Capture fetch errors
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            return originalFetch.apply(this, args)
                .catch(error => {
                    log(`Fetch Error: ${error.message}`, 'error');
                    throw error;
                });
        };
    </script>
</body>
</html>